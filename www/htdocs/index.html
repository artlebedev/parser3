@main[][l]
$request[^trim[$form:request;/]]
$request[^trim[/branches/moscow/tariff/;/]]
$request[^trim[/branches/regional/;/]]
$mode[^if(def $form:mode){^trim[^form:mode.lower[]]}]

^if(def $form:print){
	$stylesheetType[PRINT]
}{
	$stylesheetType[HTML]
}

$default_cache_time(3600)
$cache_cfg[^load[named;/_cache.cfg]]
^cache_cfg.menu{
	^if($cache_cfg.url eq "//"){
		^if(!def $request){
			$cache_time[$cache_cfg.time]
		}
	}{
		^if(^request.match[^^^trim[$cache_cfg.url;/]][]){
			$cache_time[$cache_cfg.time]
		}
	}
}
$cache_key[^request:query.match[^^([^^=]*=)][]{}_${platform}_${browser}_$stylesheetType]
$cache_time(^if($env:REQUEST_METHOD eq POST){0}{^if(def $cache_time){$cache_time}{$default_cache_time}})

# дл оладки...
# ^$cache_time=$cache_time<br />^$cache_key=$cache_key

#$hashData[^hashfile::open[$DB_HOME;data.dat]]
#^hashData.cache[$cache_key]($cache_time){
	^MAIN:pSQL.server{
		$object[^engine_mdm::dataInit[$request;$stylesheetType;$mode]]
		^object.execute[]
	}
#}
#end main
